--1: What is the total revenue generated by Olist, and how has it changed over time?

select round(sum(p.payment_value),2) as Total_revenue
from order_payments_dataset p
join orders_dataset o on p.order_id=o.order_id
where o.order_status!='cancelled' ;

--by year
select round(sum(p.payment_value),2) as Total_revenue,year(o.order_purchase_timestamp) as Year
from order_payments_dataset p
join orders_dataset o on p.order_id=o.order_id
where o.order_status!='cancelled'
group by year(o.order_purchase_timestamp) ;

--by month
select round(sum(p.payment_value),2) as Total_revenue,year(o.order_purchase_timestamp) as Year,month(o.order_purchase_timestamp) as month
from order_payments_dataset p
join orders_dataset o on p.order_id=o.order_id
where o.order_status!='cancelled'
group by year(o.order_purchase_timestamp),month(o.order_purchase_timestamp)
order by 2,3;

--by quarter
select round(sum(p.payment_value),2) as Total_revenue,year(o.order_purchase_timestamp) as Year,
datepart(quarter,o.order_purchase_timestamp) as quarter
from order_payments_dataset p
join orders_dataset o on p.order_id=o.order_id
where o.order_status!='cancelled'
group by year(o.order_purchase_timestamp),datepart(quarter,o.order_purchase_timestamp)
order by 2,3;




--2: How many orders were placed on Olist, and how does this vary by month or season?

--total orders
select distinct count(order_id) as Order_count
from  dbo.orders_dataset 


--distribution of order by months
select distinct count(order_id) as Order_count,month(order_purchase_timestamp) as Month,year(order_purchase_timestamp) as Year
from  dbo.orders_dataset 
group  by year(order_purchase_timestamp),month(order_purchase_timestamp)
order by year(order_purchase_timestamp),month(order_purchase_timestamp)  



--3: What are the most popular product categories on Olist, and how do their sales volumes
compare to each other?

select c.product_category_name_english as Category,count(o.order_id) as Count_of_orders,round(sum(pa.payment_value),2) as Revenue
from products_dataset p 
join order_items_dataset o on p.product_id=o.product_id
join order_payments_dataset pa on  o.order_id=pa.order_id
join product_category_name_translation c on p.product_category_name=c.product_category_name
group by c.product_category_name_english
order by 2 DESC


--4: What is the average order value (AOV) on Olist, and how does this vary by product category
or payment method?

--by category
select c.product_category_name_english as Category,round(avg(pa.payment_value),2) as AOV
from products_dataset p 
join order_items_dataset o on p.product_id=o.product_id
join order_payments_dataset pa on  o.order_id=pa.order_id
join product_category_name_translation c on p.product_category_name=c.product_category_name
group by c.product_category_name_english
order by 2 DESC

--by payement type
select pa.payment_type,round(avg(pa.payment_value),2) as AOV
from products_dataset p 
join order_items_dataset o on p.product_id=o.product_id
join order_payments_dataset pa on  o.order_id=pa.order_id
group by pa.payment_type
order by 2 DESC





5: How many sellers are active on Olist, and how does this number change over time?

--total sellers over the span of two years
select distinct count(s.seller_id) as sellers
from sellers_dataset s
join order_items_dataset i on  s.seller_id=i.seller_id
join orders_dataset o on i.order_id=o.order_id
where o.order_status!='canceled'


--active sellers per year
select distinct count(s.seller_id) as Active_sellers,year(o.order_purchase_timestamp) as Year
from sellers_dataset s
join order_items_dataset i on  s.seller_id=i.seller_id
join orders_dataset o on i.order_id=o.order_id
where o.order_status!='canceled'
group by year(o.order_purchase_timestamp)



6: What is the distribution of seller ratings on Olist, and how does this impact sales
performance
select  r.review_score as Rating,count(distinct s.seller_id) as Count_of_sellers
from order_items_dataset o
join dbo.order_reviews r on o.order_id=r.order_id
join sellers_dataset s on o.seller_id=s.seller_id
group by r.review_score
order by r.review_score  DESC


7.with first_purchase as(
select customer_id,CONVERT(date, min(order_purchase_timestamp)) as date_of_first_purchase
from orders_dataset
group by customer_id)
select o.customer_id,o.order_status ,CONVERT(date, o.order_purchase_timestamp),CONVERT(date,fp.date_of_first_purchase),
case when CONVERT(date, o.order_purchase_timestamp)=CONVERT(date,fp.date_of_first_purchase) then 1 else 0 end as first_purchase_flag,
case when CONVERT(date, o.order_purchase_timestamp)!=CONVERT(date,fp.date_of_first_purchase) then 1 else 0 end as repeat_purchase_flag
from orders_dataset o
inner join first_purchase fp on o.customer_id=fp.customer_id

select distinct customer_id
from orders_dataset

